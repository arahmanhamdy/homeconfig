#!/bin/bash
[ "x$ACTION" = "xadd" ] || exit 0
[ "x$DEVTYPE" = "xpartition"  -o "x$DEVTYPE" = "xdisk" ] || exit 0
DEVICE=/dev/disk/by-uuid/$ID_FS_UUID_ENC

grep -q ":$DEVICE\$" /etc/auto.usb && exit 0
grep -q "^$DEVNAME" /etc/fstab && exit 0
grep -q "^$DEVICE" /etc/fstab && exit 0
if [ -n "$ID_FS_LABEL_ENC" ]; then
	grep -q "^LABEL=$ID_FS_LABEL_ENC" /etc/fstab && exit 0
fi

seq=0
LABEL=$(echo "$ID_FS_LABEL_ENC" |sed 's, ,_,g')
if [ -z "$LABEL" ]; then
  LABEL="GenericVolume"
  MNTDIR="GenericVolume"
else
  MNTDIR="$LABEL"
fi
while ( grep -q "^$MNTDIR " /etc/auto.usb )
do
   seq=$(expr $seq + 1)
   MNTDIR="$LABEL-$seq"
done
if  blkid $DEVICE|grep -q TYPE\=\"ext3\"; then
  MOUNTOPTS="-fstype=ext3,check=none,noatime,nodiratime,data=journal,users"
elif blkid $DEVICE|grep -q ext2; then
  MOUNTOPTS="-fstype=ext2,check=none,noatime,users"
elif blkid $DEVICE|grep -q ntfs; then
  MOUNTOPTS="-fstype=ntfs-3g,uid=1000,gid=1003,users"
elif blkid $DEVICE|grep -q fat; then
  MOUNTOPTS="-fstype=vfat,uid=1000,gid=1003,users"
else
  MOUNTOPTS="-fstype=auto,ro"
fi
echo "$MNTDIR $MOUNTOPTS :$DEVICE" >> /etc/auto.usb
/usr/local/bin/usb_automount_clean
