#!/bin/bash
sudo mount --make-rprivate /
function getStatus() {
    pid=$(sudo lxc-info -p -n ${1} | awk '{print $2}')
    if [ "$pid" = "-1" ]; then
        return 1
    fi
    return 0
}

function getIP() {
    sudo lxc-attach -s NETWORK -n ${1} -- ip a s dev eth0 | grep "inet " | awk '{print $2}' | cut -d "/" -f 1
}

function rename() {
    sudo sed -i "s/lxc.utsname.*/lxc.utsname = ${destname}/" "${dest}/config"
    sudo sed -i "s#${src}#${dest}#" "${dest}/config"
    sudo sed -i "s@$src@$dest@" $dest/fstab
    sudo sed -i "s/${srcname}/${destname}/" $dest/rootfs/etc/hostname
    sudo sed -i "s/${srcname}/${destname}/" $dest/rootfs/etc/hosts

}


lxc_path="/var/lib/lxc"
if [ "$1" == "--help" ]; then
    echo "Usage lxc <commmand> [command options]"
    for x in `ls /usr/bin/lxc-* | sed -s "s#/usr/bin/lxc-##" `; do 
        echo "  lxc " $x; 
    done
    exit 0

elif [ "$1" == "ls" ]; then
    for container in $(sudo lxc-ls); do
        status=$(sudo lxc-info -s -n $container | awk '{print $2}')
        ip=""
        if [ "$status" == "RUNNING" ]; then
            ip=$(getIP $container)
        fi
        echo -e "$container \t $status \t $ip"
    done | sort -k2 -k1 | column -t
    exit 0
elif [ "$1" == "clone" -o "$1" == "rename"  ]; then
    srcname="$2"
    destname="$3"
    dest="${lxc_path}/$3"
    src="${lxc_path}/$2"
    if [ -e "$dest" ]; then
        echo Container $destname already exists
        exit 1
    fi
    if [ "$1" == "clone" ]; then
        sudo btrfs subvolume snapshot "${src}" "${dest}"
    else
        sudo mv "${src}" "${dest}"
    fi
    rename
    exit 0
elif [ "$1" == "destroy" ]; then
    dest="${lxc_path}/$2"
    if [ ! -e "${dest}" -o -z "$2" ]; then
        echo "Container doest not exist"
        exit 1
    fi
    if getStatus "$2"; then
        echo "Can not destroy container which is running"    
        exit 1
    fi
    sudo btrfs subvolume delete /var/lib/lxc/$2
    exit 0
elif [ "$#" -eq 2 ]; then
    cmd=lxc-$1
    opts=""
    if [ "$1" == "start"  ]; then
        opts=" -d "
    fi
    sudo lxc-$1 $opts -n $2
    exit 0
else 
    echo "What do you want? $*"
    exit 1
fi
