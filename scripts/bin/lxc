#!/bin/bash
function lxc_get_status() {
    pid=$(sudo lxc-info -p -n ${1} | awk '{print $2}')
    if [ "$pid" = "-1" ]; then
        return 1
    fi
    return 0
}

function lxc_get_ip() {
    sudo lxc-attach -s NETWORK -n ${1} -- ip a s dev eth0 | grep "inet " | awk '{print $2}' | cut -d "/" -f 1
}

function lxc_list() {
    for container in $(sudo lxc-ls); do
        state=$(sudo lxc-info -s -n $container | awk '{print $2}')
        ip=""
        if [ "$state" = "RUNNING" ]; then
            ip=$(lxc_get_ip $container)
        fi
        echo -e "$container \t $state \t $ip"
    done | sort -k2 -k1 | column -t
}

function lxc_rename() {
    sudo sed -i "s/lxc.utsname.*/lxc.utsname = ${destname}/" "${dest}/config"
    sudo sed -i "s#${src}#${dest}#" "${dest}/config"
    sudo sed -i "s@$src@$dest@" $dest/fstab
    sudo sed -i "s/${srcname}/${destname}/" $dest/rootfs/etc/hostname
    sudo sed -i "s/${srcname}/${destname}/" $dest/rootfs/etc/hosts

}

function clone() {
    sudo lxc-clone -s -o $1 -n $2
    sudo sed -i "s@$1@$2@" /var/lib/lxc/$2/fstab
}

if [ "$BASH_SOURCE" != "$0" ]; then
    return 0
fi


sudo mount --make-rprivate /
lxc_path="/var/lib/lxc"
if [ "$1" == "--help" ]; then
    echo "Usage lxc <commmand> [command options]"
    for x in `ls /usr/bin/lxc-* | sed -s "s#/usr/bin/lxc-##" `; do 
        echo "  lxc " $x; 
    done
    exit 0

elif [ "$1" == "ls" ]; then
    lxc_list
    exit 0
elif [ "$1" == "rename"  ]; then
    srcname="$2"
    destname="$3"
    dest="${lxc_path}/$3"
    src="${lxc_path}/$2"
    if [ -e "$dest" ]; then
        echo Container $destname already exists
        exit 1
    fi
    sudo mv "${src}" "${dest}"
    lxc_rename
    exit 0
elif [ "$1" == "clone" ]; then
    clone $2 $3
    exit 0
elif [ "$1" == "destroy" ]; then
    sudo lxc-destroy -fn $2
    exit 0
elif [ "$1" == "reclone" ]; then
    sudo lxc-destroy -fn $3
    clone $2 $3
    sudo lxc-start -d -n $3
    exit 0
elif [ "$#" -eq 2 ]; then
    cmd=lxc-$1
    opts=""
    if [ "$1" == "start"  ]; then
        opts=" -d "
    fi
    sudo lxc-$1 $opts -n $2
    exit 0
else 
    echo "What do you want? $*"
    exit 1
fi
